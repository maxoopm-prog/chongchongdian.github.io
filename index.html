<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>退货地址 - 增强历史记录版</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --tb-orange: #ff5000;
            --tb-bg: #f7f8fa;
            --text-main: #333333;
            --text-sub: #999999;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            margin: 0;
            background-color: #f2f2f2;
            font-family: -apple-system, "SF Pro Text", "PingFang SC", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- iPhone 16 比例容器 --- */
        .iphone-container {
            width: 100vw;
            max-width: 393px;
            height: 100vh;
            background: #fff;
            display: flex;
            flex-direction: column;
            padding-top: calc(10px + env(safe-area-inset-top));
            position: relative;
            overflow: hidden;
        }

        /* 顶部导航 */
        .nav-bar { height: 44px; display: flex; align-items: center; padding: 0 16px; margin-bottom: 10px; }
        .nav-left { font-size: 22px; width: 30px; }
        .nav-breadcrumb { flex: 1; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #999; }
        .nav-breadcrumb span.active { color: #333; font-weight: bold; margin: 0 4px; }
        .nav-right { font-size: 20px; width: 30px; text-align: right; font-weight: bold; }

        .main-scroll { flex: 1; overflow-y: auto; }
        .main-title { font-size: 26px; font-weight: bold; text-align: center; margin-top: 20px; color: #111; }
        .badge-line { display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 12px; }
        .membership-tag { font-size: 10px; background: #eee; padding: 1px 4px; border-radius: 2px; color: #666; }
        .status-text { color: var(--tb-orange); font-size: 14px; font-weight: 500; }
        .countdown { display: block; color: var(--text-sub); font-size: 13px; margin-top: 8px; text-align: center; }

        .method-selector { display: flex; padding: 25px 16px; gap: 10px; }
        .card { flex: 1; border: 1px solid #f2f2f2; border-radius: 12px; padding: 15px 0; text-align: center; background: #fcfcfc; }
        .card.active { border: 1.5px solid var(--tb-orange); background: #fff; }
        .card.active .name { color: var(--tb-orange); font-weight: bold; }

        .address-section { padding: 25px 16px; display: flex; font-size: 14px; }
        .addr-label { color: #666; width: 70px; flex-shrink: 0; }
        .addr-content { flex: 1; line-height: 1.6; text-align: right; }
        #display-main { display: block; font-weight: 500; color: #333; }

        .btn-submit { background: linear-gradient(90deg, #ff8e00, #ff5000); color: white; margin: 15px 16px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 24px; font-size: 16px; font-weight: bold; }

        .bottom-fixed-group { border-top: 8px solid var(--tb-bg); background: #fff; padding-bottom: env(safe-area-inset-bottom); }
        .product-card { padding: 16px; display: flex; gap: 12px; }
        .p-img { width: 80px; height: 80px; background: #f8f8f8; border-radius: 8px; flex-shrink: 0; }
        .bottom-bar { height: 60px; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: flex-end; padding: 0 16px; gap: 10px; }
        .btn-ghost { border: 1px solid #ddd; padding: 8px 18px; border-radius: 20px; font-size: 14px; }

        /* --- 编辑器及历史记录样式 --- */
        .editor-container { width: 100%; max-width: 393px; padding: 30px 20px; background: #fff; border-top: 1px solid #ddd; margin-top: 50px; }
        .input-box { width: 100%; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; font-size: 14px; background: #f9f9f9; outline: none; }
        .input-box:focus { border-color: var(--tb-orange); }
        
        .history-section { margin-top: 25px; border-top: 1px dashed #eee; padding-top: 20px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .history-item { background: #f8f8f8; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #666; cursor: pointer; border: 1px solid transparent; }
        .history-item:hover { border-color: var(--tb-orange); background: #fff; }
        .history-item strong { color: #333; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<div class="iphone-container">
    <div class="nav-bar">
        <div class="nav-left">←</div>
        <div class="nav-breadcrumb">商家处理 <span>&rsaquo;</span> <span class="active">2寄回商品</span> <span>&rsaquo;</span> 3退款结束</div>
        <div class="nav-right">···</div>
    </div>
    
    <div class="main-scroll">
        <div class="main-title">请选择退货方式</div>
        <div class="badge-line"><span class="membership-tag">铂金会员</span><span class="status-text">因您信誉良好，平台已同意您的退货申请</span></div>
        <span class="countdown">5天15时46分后未寄出将撤销退货申请</span>

        <div class="method-selector">
            <div class="card"><div class="name">上门取件</div></div>
            <div class="card"><div class="name">驿站自寄</div></div>
            <div class="card active"><div class="name">自行寄回</div></div>
        </div>

        <div class="address-section">
            <div class="addr-label">商家地址</div>
            <div class="addr-content">
                <span id="display-main">请在下方输入新地址进行同步</span>
                <span id="display-sub">收货人，电话</span>
            </div>
        </div>
        <div class="btn-submit">填写单号</div>
    </div>

    <div class="bottom-fixed-group">
        <div class="product-card">
            <div class="p-img"></div>
            <div class="p-info">
                <div class="p-title">运动鞋垫男款吸汗防臭减震气垫久站防痛超轻软弹透气...</div>
                <div style="color:#999; font-size:12px; margin-top:5px;">颜色分类：【1双】抗菌除臭...</div>
            </div>
        </div>
        <div class="bottom-bar">
            <div class="btn-ghost">平台介入</div>
            <div class="btn-ghost">撤销申请</div>
        </div>
    </div>
</div>

<div class="editor-container">
    <div style="font-weight:bold; margin-bottom:15px; font-size:18px; border-left: 4px solid var(--tb-orange); padding-left: 10px;">智能地址更新</div>
    <textarea id="smart-input" class="input-box" rows="4" placeholder="粘贴地址、姓名、电话..."></textarea>
    <button onclick="handleSmartParse()" style="width:100%; padding:15px; background:var(--tb-orange); color:#fff; border:none; border-radius:10px; font-weight:bold; font-size:16px; cursor:pointer;">识别并同步到预览</button>

    <div class="history-section">
        <div class="history-header">
            <span style="font-size: 14px; font-weight: bold; color: #999;">识别历史 (最近10条)</span>
            <span onclick="clearHistory()" style="font-size: 12px; color: var(--tb-orange); cursor: pointer;">清除全部</span>
        </div>
        <div id="history-list">
            </div>
    </div>
</div>

<script>
    let addressHistory = JSON.parse(localStorage.getItem('tb_address_history_v3') || '[]');

    function handleSmartParse() {
        const rawText = document.getElementById('smart-input').value.trim();
        if (!rawText) return;

        const phoneReg = /(1[3-9]\d{9})/;
        const phoneMatch = rawText.match(phoneReg);
        const phone = phoneMatch ? phoneMatch[0] : "";

        let cleanText = rawText.replace(phone, "").replace(/[,，\s]+/g, " ").trim();
        const parts = cleanText.split(/\s+/).filter(p => p.length > 0);
        
        let name = "收货人";
        let address = cleanText;

        if (parts.length >= 2) {
            let nameIndex = 0;
            let minLen = 999;
            parts.forEach((p, idx) => {
                if (p.length < minLen && !p.includes('省') && !p.includes('市')) {
                    minLen = p.length;
                    nameIndex = idx;
                }
            });
            name = parts[nameIndex];
            address = parts.filter((_, idx) => idx !== nameIndex).join("");
        }

        const finalSub = `${name}，${phone}`;
        updatePreview(address, finalSub);
        saveToHistory(address, finalSub);
    }

    function updatePreview(main, sub) {
        document.getElementById('display-main').innerText = main;
        document.getElementById('display-sub').innerText = sub;
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function saveToHistory(main, sub) {
        // 过滤掉重复项
        addressHistory = addressHistory.filter(item => item.main !== main);
        // 插入最前面
        addressHistory.unshift({ main, sub });
        // 限制 10 条
        if (addressHistory.length > 10) addressHistory.pop();
        
        localStorage.setItem('tb_address_history_v3', JSON.stringify(addressHistory));
        renderHistory();
    }

    function renderHistory() {
        const listDiv = document.getElementById('history-list');
        if (addressHistory.length === 0) {
            listDiv.innerHTML = '<div style="color:#ccc; font-size:12px; text-align:center; padding:20px;">暂无识别记录</div>';
            return;
        }
        listDiv.innerHTML = addressHistory.map((item, index) => `
            <div class="history-item" onclick="applyHistory(${index})">
                <strong>${item.main.substring(0, 25)}${item.main.length > 25 ? '...' : ''}</strong>
                <span>${item.sub}</span>
            </div>
        `).join('');
    }

    function applyHistory(index) {
        const item = addressHistory[index];
        document.getElementById('smart-input').value = `${item.main} ${item.sub}`;
        updatePreview(item.main, item.sub);
    }

    function clearHistory() {
        if(confirm('确定要清除所有识别记录吗？')) {
            addressHistory = [];
            localStorage.removeItem('tb_address_history_v3');
            renderHistory();
        }
    }

    window.onload = renderHistory;
</script>

</body>
</html>
